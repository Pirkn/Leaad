<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Agent - Reddit Post Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            min-height: calc(100vh - 40px);
        }

        .sidebar {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 15px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h2 i {
            color: #667eea;
        }

        .subsection {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 10px;
            background: #ffffff;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .subsection h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 8px;
        }

        .subsection h3 i {
            color: #28a745;
        }

        .subsection p {
            margin-bottom: 15px;
            color: #6c757d;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        input[type="email"], input[type="password"], input[type="text"], input[type="url"], textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus, input[type="url"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }

        .result-header {
            background: #e9ecef;
            padding: 15px 20px;
            margin: -25px -25px 20px -25px;
            border-radius: 15px 15px 0 0;
            font-weight: bold;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .result-content {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.6;
        }

        .json-key {
            color: #0066cc;
            font-weight: bold;
        }

        .json-string {
            color: #28a745;
        }

        .json-number {
            color: #fd7e14;
        }

        .json-boolean {
            color: #6f42c1;
        }

        .json-null {
            color: #6c757d;
            font-style: italic;
        }

        .hidden {
            display: none;
        }

        .user-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .copy-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .copy-btn.copied {
            background: #28a745;
        }

        .reddit-post-card {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .reddit-post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .reddit-post-card h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subreddit-badge {
            background: #ff4500;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
        }

        .post-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .post-body {
            color: #555;
            line-height: 1.7;
            white-space: pre-wrap;
            font-size: 15px;
        }

        .post-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .post-actions button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .post-actions button:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Enhanced Response Section */
        .response-container {
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 20px;
        }

        .response-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .response-header h3 {
            margin: 0;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .response-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            backdrop-filter: blur(10px);
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .action-btn.success {
            background: rgba(40, 167, 69, 0.8);
        }

        .response-content {
            max-height: 500px;
            overflow-y: auto;
            padding: 25px;
            background: #fafbfc;
        }

        .response-content::-webkit-scrollbar {
            width: 8px;
        }

        .response-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .response-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .response-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .post-grid {
            display: grid;
            gap: 20px;
        }

        .post-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .post-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subreddit-tag {
            background: #ff4500;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .post-number {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .post-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .post-content {
            color: #555;
            line-height: 1.6;
            font-size: 14px;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .post-footer {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .footer-btn {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .footer-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .footer-btn.success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .success-message {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .error-message {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            transform: scale(1);
            transition: transform 0.3s ease;
        }

        .modal.hidden .modal-content {
            transform: scale(0.9);
        }

        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px 25px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .modal-body {
            padding: 25px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar, .main-content {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }

            .response-header {
                padding: 15px 20px;
            }

            .response-content {
                padding: 20px;
            }

            .post-footer {
                flex-direction: column;
            }

            .footer-btn {
                width: 100%;
                justify-content: center;
            }
        }

        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1><i class="fas fa-robot"></i> Marketing Agent</h1>
            
            <div id="statusDiv" class="status info">
                <i class="fas fa-info-circle"></i>
                <span>Initializing...</span>
            </div>

            <!-- Authentication Section -->
            <div class="section">
                <h2><i class="fas fa-user-lock"></i> Authentication</h2>
                
                <div id="loginForm">
                    <div class="form-group">
                        <label for="email"><i class="fas fa-envelope"></i> Email:</label>
                        <input type="email" id="email" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password"><i class="fas fa-key"></i> Password:</label>
                        <input type="password" id="password" placeholder="Enter your password" required>
                    </div>
                    
                    <button class="btn" onclick="signIn()">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                    <button class="btn btn-secondary" onclick="signUp()">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </button>
                </div>

                <div id="userInfo" class="user-info hidden">
                    <h3><i class="fas fa-user"></i> User Information</h3>
                    <p id="userDetails"></p>
                    <button class="btn btn-danger" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </button>
                </div>
            </div>

            <!-- API Testing Section -->
            <div class="section">
                <h2><i class="fas fa-cogs"></i> API Testing</h2>
                
                <div>
                    <button class="btn" onclick="testHealthRoute()">
                        <i class="fas fa-heartbeat"></i> Health Check
                    </button>
                    <button class="btn" onclick="testProtectedRoute()">
                        <i class="fas fa-shield-alt"></i> Protected Route
                    </button>
                </div>
                
                <div id="apiResult" class="result hidden">
                    <div class="result-header">
                        <span><i class="fas fa-code"></i> API Response</span>
                        <button class="copy-btn" onclick="copyToClipboard('apiResult')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="result-content" id="apiResultContent"></div>
                </div>
            </div>

            <!-- Viral Posts Section -->
            <div class="section">
                <h2><i class="fas fa-fire"></i> Viral Posts</h2>
                
                <div>
                    <button class="btn" onclick="getViralPosts()">
                        <i class="fas fa-fire"></i> Load Viral Posts
                    </button>
                </div>
                
                <div id="viralPostsResult" class="result hidden">
                    <div class="result-header">
                        <span><i class="fas fa-fire"></i> Viral Posts</span>
                        <button class="copy-btn" onclick="copyToClipboard('viralPostsResult')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="result-content" id="viralPostsResultContent"></div>
                </div>
            </div>

            <!-- Karma Helper Section -->
            <div class="section">
                <h2><i class="fas fa-chart-line"></i> Karma Helper</h2>
                
                <!-- Get Karma Posts Section -->
                <div class="subsection">
                    <h3><i class="fas fa-list"></i> View My Karma Posts</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> View all your previously generated karma posts with images
                    </p>
                    
                    <div>
                        <button class="btn" onclick="getKarmaPosts()">
                            <i class="fas fa-list"></i> Load My Karma Posts
                        </button>
                    </div>
                </div>
                
                <!-- Get Post Karma Section -->
                <div class="subsection">
                    <h3><i class="fas fa-image"></i> Generate Karma Post with Image</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> Generates a Reddit post with WebP image and saves to database
                    </p>
                    
                    <div>
                        <button class="btn btn-success" onclick="getPostKarma()">
                            <i class="fas fa-image"></i> Generate Karma Post
                        </button>
                    </div>
                </div>
                
                <!-- Manual Subreddit Analysis -->
                <div class="subsection">
                    <h3><i class="fas fa-user-edit"></i> Trending Posts Analysis</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> Analyzes trending posts from popular subreddits and provides karma optimization strategies
                    </p>
                    <div class="form-group">
                        <label for="subreddit_name"><i class="fas fa-reddit"></i> Subreddit Name (Optional):</label>
                        <input type="text" id="subreddit_name" placeholder="Enter subreddit name (e.g., saas, microsaas)" value="saas">
                        <small style="color: #6c757d; font-size: 12px;">Leave empty to analyze random trending subreddits</small>
                    </div>
                    
                    <div>
                        <button class="btn" onclick="getKarmaAnalysis()">
                            <i class="fas fa-chart-line"></i> Analyze Trending Posts
                        </button>
                    </div>
                </div>

                <!-- Auto Karma Builder -->
                <div class="subsection">
                    <h3><i class="fas fa-magic"></i> Smart Karma Builder</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> Generates personalized karma strategies based on your experience level and interests
                    </p>
                    
                    <div class="form-group">
                        <label for="karma_level"><i class="fas fa-user"></i> Your Current Karma Level:</label>
                        <select id="karma_level">
                            <option value="beginner">Beginner (0-50 karma)</option>
                            <option value="intermediate">Intermediate (50-500 karma)</option>
                            <option value="advanced">Advanced (500+ karma)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="interest_category"><i class="fas fa-heart"></i> Interest Category:</label>
                        <select id="interest_category">
                            <option value="general">General/Mixed Topics</option>
                            <option value="wholesome">Wholesome & Positive</option>
                            <option value="advice">Advice & Help</option>
                            <option value="creative">Creative & Fun</option>
                            <option value="discussion">Questions & Discussion</option>
                        </select>
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="getSmartKarmaAnalysis()">
                            <i class="fas fa-magic"></i> Generate Smart Karma Plan
                        </button>
                    </div>
                </div>
                
                <div id="karmaResult" class="result hidden">
                    <div class="result-header">
                        <span><i class="fas fa-chart-line"></i> Karma Analysis</span>
                        <button class="copy-btn" onclick="copyToClipboard('karmaResult')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="result-content" id="karmaResultContent"></div>
                </div>

                <div id="smartKarmaResult" class="result hidden">
                    <div class="result-header">
                        <span><i class="fas fa-magic"></i> Smart Karma Plan</span>
                        <button class="copy-btn" onclick="copyToClipboard('smartKarmaResult')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="result-content" id="smartKarmaResultContent"></div>
                </div>

                <div id="karmaPostsResult" class="result hidden">
                    <div class="result-header">
                        <span><i class="fas fa-list"></i> My Karma Posts</span>
                        <button class="copy-btn" onclick="copyToClipboard('karmaPostsResult')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="result-content" id="karmaPostsResultContent"></div>
                </div>

                <div id="karmaPostResult" class="result hidden">
                    <div class="result-header">
                        <span><i class="fas fa-image"></i> Karma Post with Image</span>
                        <button class="copy-btn" onclick="copyToClipboard('karmaPostResult')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="result-content" id="karmaPostResultContent"></div>
                </div>
            </div>

            <!-- Product Management Section -->
            <div class="section">
                <h2><i class="fas fa-box"></i> Product Management</h2>
                
                <div>
                    <button class="btn" onclick="getUserProducts()">
                        <i class="fas fa-list"></i> Get My Products
                    </button>
                    <button class="btn btn-success" onclick="showCreateProductForm()">
                        <i class="fas fa-plus"></i> Create Product
                    </button>
                </div>
                
                <div id="productsResult" class="result hidden">
                    <div class="result-header">
                        <span><i class="fas fa-box"></i> My Products</span>
                        <button class="copy-btn" onclick="copyToClipboard('productsResult')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="result-content" id="productsResultContent"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="section">
                <h2><i class="fas fa-reddit"></i> Generate Reddit Posts</h2>
                
                <div class="form-group">
                    <label for="product_select"><i class="fas fa-box"></i> Select Your Product:</label>
                    <select id="product_select" onchange="onProductSelect()" required>
                        <option value="">-- Select a product --</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadUserProducts()" style="margin-top: 10px;">
                        <i class="fas fa-refresh"></i> Refresh Products
                    </button>
                </div>
                
                <div id="selectedProductInfo" class="user-info hidden">
                    <h3><i class="fas fa-info-circle"></i> Selected Product Details</h3>
                    <div id="productInfoContent"></div>
                </div>
                
                <button class="btn btn-success" onclick="generateRedditPost()" id="generateRedditBtn" disabled>
                    <i class="fas fa-magic"></i> Generate Reddit Posts
                </button>
                
                <div id="productDetailsResult" class="response-container hidden">
                    <div class="response-header">
                        <h3><i class="fas fa-info-circle"></i> Product Details</h3>
                        <div class="response-actions">
                            <button class="action-btn" onclick="copyProductDetails()">
                                <i class="fas fa-copy"></i> Copy Details
                            </button>
                            <button class="action-btn" onclick="exportProductDetailsAsJSON()">
                                <i class="fas fa-download"></i> Export JSON
                            </button>
                        </div>
                    </div>
                    <div class="response-content" id="productDetailsResultContent"></div>
                </div>
                
                <div id="redditResult" class="response-container hidden">
                    <div class="response-header">
                        <h3><i class="fas fa-reddit"></i> Generated Reddit Posts</h3>
                        <div class="response-actions">
                            <button class="action-btn" onclick="copyAllPosts()">
                                <i class="fas fa-copy"></i> Copy All
                            </button>
                            <button class="action-btn" onclick="exportAsJSON()">
                                <i class="fas fa-download"></i> Export JSON
                            </button>
                        </div>
                    </div>
                    <div class="response-content" id="redditResultContent"></div>
                </div>
            </div>

            <!-- Create Product Modal -->
            <div id="createProductModal" class="modal hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-plus"></i> Create New Product</h3>
                        <button class="modal-close" onclick="hideCreateProductForm()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="newProductName"><i class="fas fa-tag"></i> Product Name:</label>
                            <input type="text" id="newProductName" placeholder="Enter product name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newProductUrl"><i class="fas fa-link"></i> Product URL:</label>
                            <input type="url" id="newProductUrl" placeholder="https://example.com" onchange="checkNewProductLink()">
                            <button id="generateNewProductDetailsBtn" class="btn btn-secondary" onclick="generateNewProductDetails()" style="margin-top: 10px; display: none;">
                                <i class="fas fa-robot"></i> Generate Details with AI
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="newProductDescription"><i class="fas fa-info-circle"></i> Description:</label>
                            <textarea id="newProductDescription" placeholder="Describe your product" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="newProductTargetAudience"><i class="fas fa-users"></i> Target Audience:</label>
                            <input type="text" id="newProductTargetAudience" placeholder="Who is your target audience?">
                        </div>
                        
                        <div class="form-group">
                            <label for="newProductProblemSolved"><i class="fas fa-lightbulb"></i> Problem Solved:</label>
                            <textarea id="newProductProblemSolved" placeholder="What problem does your product solve?" rows="3"></textarea>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="hideCreateProductForm()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn btn-success" onclick="createProduct()">
                                <i class="fas fa-save"></i> Create Product
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Replace these with your actual Supabase URL and anon key
        const SUPABASE_URL = 'https://eagkbdpnrxwxgyhxrrch.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhZ2tiZHBucnh3eGd5aHhycmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwNDMyMDksImV4cCI6MjA2OTYxOTIwOX0.HGnY3qr62Vql73_zOEEasynuwN55lqraFtnknkBI4Bw';
        
        // Flask app URL
        const API_BASE_URL = 'http://127.0.0.1:5000';
        
        let supabase;
        let currentUser = null;
        let accessToken = null;

        // Initialize Supabase client
        function initSupabase() {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
                showStatus('Please update SUPABASE_URL and SUPABASE_ANON_KEY in the HTML file', 'error');
                return;
            }

            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Check if user is already logged in
            checkAuthStatus();
            
            // Listen for auth changes
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event, session);
                if (session) {
                    currentUser = session.user;
                    accessToken = session.access_token;
                    showUserInfo();
                    showStatus('Successfully authenticated!', 'success');
                    // Auto-load products when user signs in
                    loadUserProducts();
                } else {
                    currentUser = null;
                    accessToken = null;
                    showLoginForm();
                    showStatus('Please sign in to continue', 'info');
                    // Clear products when user signs out
                    userProducts = [];
                    selectedProductId = null;
                    populateProductDropdown();
                }
            });
        }

        // Check current auth status
        async function checkAuthStatus() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    accessToken = session.access_token;
                    showUserInfo();
                    showStatus('Welcome back!', 'success');
                } else {
                    showLoginForm();
                    showStatus('Please sign in to continue', 'info');
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showStatus('Error checking authentication status', 'error');
            }
        }

        // Sign in
        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showStatus('Please enter both email and password', 'error');
                return;
            }

            try {
                showStatus('Signing in...', 'info');
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    showStatus(`Sign in failed: ${error.message}`, 'error');
                } else {
                    showStatus('Sign in successful!', 'success');
                    // Clear form
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                }
            } catch (error) {
                console.error('Sign in error:', error);
                showStatus('An error occurred during sign in', 'error');
            }
        }

        // Sign up
        async function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showStatus('Please enter both email and password', 'error');
                return;
            }

            try {
                showStatus('Creating account...', 'info');
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    showStatus(`Sign up failed: ${error.message}`, 'error');
                } else {
                    showStatus('Account created! Please check your email for verification.', 'success');
                    // Clear form
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                }
            } catch (error) {
                console.error('Sign up error:', error);
                showStatus('An error occurred during sign up', 'error');
            }
        }

        // Sign out
        async function signOut() {
            try {
                showStatus('Signing out...', 'info');
                const { error } = await supabase.auth.signOut();
                if (error) {
                    showStatus(`Sign out failed: ${error.message}`, 'error');
                } else {
                    showStatus('Signed out successfully', 'success');
                }
            } catch (error) {
                console.error('Sign out error:', error);
                showStatus('An error occurred during sign out', 'error');
            }
        }

        // Product Management Functions
        async function getUserProducts() {
            if (!accessToken) {
                showProductsResult('Error: You must be signed in to view your products', null, true);
                return;
            }

            try {
                showProductsResult('Loading your products...', true);
                
                const response = await fetch(`${API_BASE_URL}/products`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.products) {
                    showProducts(data.products);
                } else {
                    showProductsResult(`Error: ${response.status} ${response.statusText}`, false, null, true);
                }
            } catch (error) {
                showProductsResult(`Error: ${error.message}`, false, null, true);
            }
        }

        function showCreateProductForm() {
            if (!accessToken) {
                showToast('You must be signed in to create products', 'error');
                return;
            }
            const modal = document.getElementById('createProductModal');
            modal.classList.remove('hidden');
            console.log('Modal shown:', !modal.classList.contains('hidden'));
        }

        function hideCreateProductForm() {
            const modal = document.getElementById('createProductModal');
            modal.classList.add('hidden');
            console.log('Modal hidden:', modal.classList.contains('hidden'));
            // Clear form fields
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductUrl').value = '';
            document.getElementById('newProductDescription').value = '';
            document.getElementById('newProductTargetAudience').value = '';
            document.getElementById('newProductProblemSolved').value = '';
        }

        // Add click outside modal to close
        function setupModalHandlers() {
            const modal = document.getElementById('createProductModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    hideCreateProductForm();
                }
            });
            
            // Prevent closing when clicking inside modal content
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    hideCreateProductForm();
                }
            });
        }

        async function createProduct() {
            if (!accessToken) {
                showToast('You must be signed in to create products', 'error');
                return;
            }

            const name = document.getElementById('newProductName').value;
            const url = document.getElementById('newProductUrl').value;
            const description = document.getElementById('newProductDescription').value;
            const targetAudience = document.getElementById('newProductTargetAudience').value;
            const problemSolved = document.getElementById('newProductProblemSolved').value;

            if (!name) {
                showToast('Product name is required', 'error');
                return;
            }

            try {
                showToast('Creating product...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/create_product`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        url: url || null,
                        description: description || null,
                        target_audience: targetAudience || null,
                        problem_solved: problemSolved || null
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.product) {
                    showToast('Product created successfully!', 'success');
                    hideCreateProductForm();
                    // Refresh products list
                    getUserProducts();
                } else {
                    showToast(`Error: ${data.error || 'Failed to create product'}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        function showProductsResult(result, isLoading = false, data = null, isError = false) {
            const resultDiv = document.getElementById('productsResult');
            const contentDiv = document.getElementById('productsResultContent');
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading"></div> ${result}`;
            } else {
                if (isError) {
                    contentDiv.innerHTML = `<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> ${result}</span>`;
                } else if (data) {
                    contentDiv.innerHTML = formatJSON(result, data);
                } else {
                    contentDiv.textContent = result;
                }
            }
            
            resultDiv.classList.remove('hidden');
        }

        function showProducts(products) {
            const resultDiv = document.getElementById('productsResult');
            const contentDiv = document.getElementById('productsResultContent');
            
            if (products.length === 0) {
                contentDiv.innerHTML = `
                    <div class="success-message">
                        <i class="fas fa-info-circle"></i>
                        <strong>No products found.</strong> Create your first product to get started!
                    </div>
                `;
            } else {
                let html = `<div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <strong>Success!</strong> Found ${products.length} product(s).
                </div>
                <div class="post-grid">`;
                
                products.forEach((product, index) => {
                    const createdAt = new Date(product.created_at).toLocaleDateString();
                    const updatedAt = new Date(product.updated_at).toLocaleDateString();
                    
                    html += `
                        <div class="post-card">
                            <div class="post-header">
                                <div class="post-meta">
                                    <div class="subreddit-tag" style="background: #28a745;">
                                        <i class="fas fa-box"></i> Product ${index + 1}
                                    </div>
                                </div>
                            </div>
                            <div class="post-title">${product.name}</div>
                            <div class="post-content">
                                ${product.description ? `<strong>Description:</strong> ${product.description}<br><br>` : ''}
                                ${product.url ? `<strong>URL:</strong> <a href="${product.url}" target="_blank">${product.url}</a><br><br>` : ''}
                                ${product.target_audience ? `<strong>Target Audience:</strong> ${product.target_audience}<br><br>` : ''}
                                ${product.problem_solved ? `<strong>Problem Solved:</strong> ${product.problem_solved}<br><br>` : ''}
                                <strong>Created:</strong> ${createdAt}<br>
                                <strong>Updated:</strong> ${updatedAt}
                            </div>
                            <div class="post-footer">
                                <button class="footer-btn" onclick="copyProductInfo(${index})">
                                    <i class="fas fa-copy"></i> Copy Info
                                </button>
                                <button class="footer-btn" onclick="copyProductName(${index})">
                                    <i class="fas fa-tag"></i> Copy Name
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Store products data for copy functions
                window.productsData = products;
                
                contentDiv.innerHTML = html;
            }
            
            resultDiv.classList.remove('hidden');
            
            // Add success animation
            resultDiv.classList.add('success-animation');
            setTimeout(() => resultDiv.classList.remove('success-animation'), 600);
        }

        function copyProductInfo(index) {
            if (!window.productsData || !window.productsData[index]) {
                showToast('Product data not available', 'error');
                return;
            }
            
            const product = window.productsData[index];
            const info = `Product: ${product.name}
${product.description ? `Description: ${product.description}` : ''}
${product.url ? `URL: ${product.url}` : ''}
${product.target_audience ? `Target Audience: ${product.target_audience}` : ''}
${product.problem_solved ? `Problem Solved: ${product.problem_solved}` : ''}`;
            
            navigator.clipboard.writeText(info).then(() => {
                showToast('Product info copied to clipboard!', 'success');
                updateProductButtonState(index, 'info');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function copyProductName(index) {
            if (!window.productsData || !window.productsData[index]) {
                showToast('Product data not available', 'error');
                return;
            }
            
            const product = window.productsData[index];
            
            navigator.clipboard.writeText(product.name).then(() => {
                showToast('Product name copied to clipboard!', 'success');
                updateProductButtonState(index, 'name');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function updateProductButtonState(index, type) {
            const postCard = document.querySelectorAll('.post-card')[index];
            if (!postCard) return;
            
            const buttons = postCard.querySelectorAll('.footer-btn');
            buttons.forEach(btn => btn.classList.remove('success'));
            
            if (type === 'info') {
                buttons[0].classList.add('success');
            } else if (type === 'name') {
                buttons[1].classList.add('success');
            }
            
            setTimeout(() => {
                buttons.forEach(btn => btn.classList.remove('success'));
            }, 2000);
        }

        // Test health route (public)
        async function testHealthRoute() {
            try {
                showApiResult('Testing health route...', true);
                
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                const resultText = `Status: ${response.status} ${response.statusText}\n\nResponse Data:\n${JSON.stringify(data, null, 2)}`;
                showApiResult(resultText, false, data);
            } catch (error) {
                showApiResult(`Error: ${error.message}`, false, null, true);
            }
        }

        // Test protected route (requires authentication)
        async function testProtectedRoute() {
            if (!accessToken) {
                showApiResult('Error: You must be signed in to test the protected route', false, null, true);
                return;
            }

            try {
                showApiResult('Testing protected route...', true);
                
                const response = await fetch(`${API_BASE_URL}/protected`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                const resultText = `Status: ${response.status} ${response.statusText}\n\nResponse Data:\n${JSON.stringify(data, null, 2)}`;
                showApiResult(resultText, false, data);
            } catch (error) {
                showApiResult(`Error: ${error.message}`, false, null, true);
            }
        }

        // Get Viral Posts
        async function getViralPosts() {
            try {
                showViralPostsResult('Loading viral posts...', true);
                
                const response = await fetch(`${API_BASE_URL}/get-viral-posts`);
                const data = await response.json();
                
                if (response.ok && data) {
                    showViralPosts(data);
                } else {
                    showViralPostsResult(`Error: ${response.status} ${response.statusText}`, false, null, true);
                }
            } catch (error) {
                showViralPostsResult(`Error: ${error.message}`, false, null, true);
            }
        }

                // Get Karma Analysis
        async function getKarmaAnalysis() {
            if (!accessToken) {
                showKarmaResult('Error: You must be signed in to analyze karma', null, true);
                return;
            }

            const subredditName = document.getElementById('subreddit_name').value;
            
            if (!subredditName) {
                showKarmaResult('Error: Please enter a subreddit name', null, true);
                return;
            }

            try {
                showKarmaResult('Analyzing karma patterns from trending posts...', true);
                
                const response = await fetch(`${API_BASE_URL}/get_karma`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();

                if (response.ok && data.response) {
                    showKarmaAnalysis(data.response);
                } else {
                    showKarmaResult(`Error: ${response.status} ${response.statusText}`, false, null, true);
                }
            } catch (error) {
                showKarmaResult(`Error: ${error.message}`, false, null, true);
            }
        }

        // Get Karma Posts
        async function getKarmaPosts() {
            if (!accessToken) {
                showKarmaPostsResult('Error: You must be signed in to view karma posts', null, true);
                return;
            }

            try {
                showKarmaPostsResult('Loading your karma posts...', true);
                
                const response = await fetch(`${API_BASE_URL}/get_karma_posts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();

                if (response.ok && data.karma_posts) {
                    showKarmaPosts(data.karma_posts);
                } else {
                    showKarmaPostsResult(`Error: ${response.status} ${response.statusText}`, false, null, true);
                }
            } catch (error) {
                showKarmaPostsResult(`Error: ${error.message}`, false, null, true);
            }
        }

        // Create Karma Post with Image
        async function getPostKarma() {
            if (!accessToken) {
                showKarmaPostResult('Error: You must be signed in to generate karma posts', null, true);
                return;
            }

            try {
                showKarmaPostResult('Generating karma post with image...', true);
                
                const response = await fetch(`${API_BASE_URL}/create_karma_post`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();

                if (response.ok && data) {
                    showKarmaPost(data);
                } else {
                    showKarmaPostResult(`Error: ${response.status} ${response.statusText}`, false, null, true);
                }
            } catch (error) {
                showKarmaPostResult(`Error: ${error.message}`, false, null, true);
            }
        }

        // Get Smart Karma Analysis
        async function getSmartKarmaAnalysis() {
            if (!accessToken) {
                showSmartKarmaResult('Error: You must be signed in to get karma analysis', null, true);
                return;
            }

            const karmaLevel = document.getElementById('karma_level').value;
            const interestCategory = document.getElementById('interest_category').value;

            try {
                showSmartKarmaResult('Analyzing trending posts and generating personalized karma strategy...', true);
                
                // Use the existing get_karma endpoint multiple times for different analysis
                const response = await fetch(`${API_BASE_URL}/get_karma`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();

                if (response.ok && data.response) {
                    // Enhance the response with user-specific context
                    const enhancedResponse = `# Smart Karma Strategy for ${karmaLevel} level user

## Your Profile
- **Karma Level**: ${karmaLevel}
- **Interest Category**: ${interestCategory}
- **Analysis Date**: ${new Date().toLocaleDateString()}

## Personalized Analysis
${data.response}

## Additional Tips for ${karmaLevel} Users
${getKarmaLevelTips(karmaLevel)}

## Best Practices for ${interestCategory} Content
${getInterestCategoryTips(interestCategory)}

## Next Steps
1. Start with the recommended subreddits above
2. Focus on quality over quantity
3. Engage authentically with the community
4. Monitor your karma growth weekly
5. Adjust strategy based on what works best for you`;
                    
                    showSmartKarmaAnalysis(enhancedResponse);
                } else {
                    showSmartKarmaResult(`Error: ${response.status} ${response.statusText}`, false, null, true);
                }
            } catch (error) {
                showSmartKarmaResult(`Error: ${error.message}`, false, null, true);
            }
        }

        // Helper function to get karma level specific tips
        function getKarmaLevelTips(level) {
            const tips = {
                'beginner': `- Start with r/askreddit and r/nostupidquestions
- Focus on asking genuine questions
- Avoid controversial topics initially
- Build karma slowly and steadily
- Read subreddit rules before posting`,
                'intermediate': `- Try more diverse subreddits
- Share personal experiences when relevant
- Engage in meaningful discussions
- Help other users with advice
- Consider posting original content`,
                'advanced': `- You can handle most subreddits
- Share expertise in your areas of knowledge
- Create high-quality original content
- Mentor newer users
- Experiment with different content types`
            };
            return tips[level] || tips['beginner'];
        }

        // Helper function to get interest category specific tips
        function getInterestCategoryTips(category) {
            const tips = {
                'general': `- Focus on universal topics that appeal to everyone
- Ask questions that encourage diverse responses
- Share interesting facts or observations
- Engage with trending topics respectfully`,
                'wholesome': `- Share positive experiences and uplifting content
- Compliment others genuinely
- Focus on feel-good stories and moments
- Avoid negative or controversial topics`,
                'advice': `- Provide helpful, actionable advice
- Ask for advice when you genuinely need it
- Share personal experiences that could help others
- Be supportive and encouraging`,
                'creative': `- Share original ideas and creative content
- Engage with writing prompts and creative challenges
- Share interesting observations or thoughts
- Participate in creative discussions`,
                'discussion': `- Ask thought-provoking questions
- Engage in meaningful debates respectfully
- Share different perspectives
- Encourage open dialogue`
            };
            return tips[category] || tips['general'];
        }

        // Check if product link is entered and show/hide generate details button
        function checkProductLink() {
            const productLink = document.getElementById('product_website_link').value;
            const generateDetailsBtn = document.getElementById('generateDetailsBtn');
            
            if (productLink && productLink.trim() !== '') {
                generateDetailsBtn.style.display = 'inline-flex';
            } else {
                generateDetailsBtn.style.display = 'none';
            }
        }

        // Generate Product Details
        async function generateProductDetails() {
            const productWebsiteLink = document.getElementById('product_website_link').value;

            if (!productWebsiteLink) {
                showProductDetailsResult('Error: Please enter a product website link.', null, true);
                return;
            }

            try {
                showProductDetailsResult('Generating product details...', true);
                
                const response = await fetch(`${API_BASE_URL}/generate-product-details`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_website_link: productWebsiteLink
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data) {
                    showProductDetails(data);
                } else {
                    showProductDetailsResult(`Error: ${response.status} ${response.statusText}`, false, null, true);
                }
            } catch (error) {
                showProductDetailsResult(`Error: ${error.message}`, false, null, true);
            }
        }



        // UI helper functions
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            const icon = statusDiv.querySelector('i');
            const text = statusDiv.querySelector('span');
            
            text.textContent = message;
            statusDiv.className = `status ${type}`;
            
            // Update icon based on type
            icon.className = type === 'success' ? 'fas fa-check-circle' : 
                           type === 'error' ? 'fas fa-exclamation-circle' : 
                           'fas fa-info-circle';
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }

        function showUserInfo() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            
            const userDetails = document.getElementById('userDetails');
            userDetails.innerHTML = `
                <strong>Email:</strong> ${currentUser.email}<br>
                <strong>User ID:</strong> ${currentUser.id}<br>
                <strong>Last Sign In:</strong> ${new Date(currentUser.last_sign_in_at).toLocaleString()}
            `;
        }

        function showApiResult(result, isLoading = false, data = null, isError = false) {
            const resultDiv = document.getElementById('apiResult');
            const contentDiv = document.getElementById('apiResultContent');
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading"></div> ${result}`;
            } else {
                if (isError) {
                    contentDiv.innerHTML = `<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> ${result}</span>`;
                } else if (data) {
                    contentDiv.innerHTML = formatJSON(result, data);
                } else {
                    contentDiv.textContent = result;
                }
            }
            
            resultDiv.classList.remove('hidden');
        }

        function showProductDetailsResult(result, isLoading = false, data = null, isError = false) {
            const resultDiv = document.getElementById('productDetailsResult');
            const contentDiv = document.getElementById('productDetailsResultContent');
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading"></div> ${result}`;
            } else {
                if (isError) {
                    contentDiv.innerHTML = `<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> ${result}</span>`;
                } else if (data) {
                    contentDiv.innerHTML = formatJSON(result, data);
                } else {
                    contentDiv.textContent = result;
                }
            }
            
            resultDiv.classList.remove('hidden');
        }

        function showProductDetails(details) {
            const resultDiv = document.getElementById('productDetailsResult');
            const contentDiv = document.getElementById('productDetailsResultContent');
            
            // Automatically fill the form fields with generated product details
            if (details.target_audience) {
                document.getElementById('product_target_audience').value = details.target_audience;
            }
            if (details.description) {
                document.getElementById('product_description').value = details.description;
            }
            if (details.problem_solved) {
                document.getElementById('product_main_benefit').value = details.problem_solved;
            }
            
            let html = `<div class="success-message">
                <i class="fas fa-check-circle"></i>
                <strong>Success!</strong> Product details generated and form fields automatically filled.
            </div>
            <div class="post-card">
                <div class="post-header">
                    <div class="post-meta">
                        <div class="subreddit-tag" style="background: #28a745;">
                            <i class="fas fa-info-circle"></i> Product Details
                        </div>
                    </div>
                </div>
                <div class="post-content">
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-label">Target Audience</div>
                            <div class="stat-number" style="font-size: 16px; color: #495057;">${details.target_audience || 'Not specified'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Description</div>
                            <div class="stat-number" style="font-size: 16px; color: #495057;">${details.description || 'Not specified'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Problem Solved</div>
                            <div class="stat-number" style="font-size: 16px; color: #495057;">${details.problem_solved || 'Not specified'}</div>
                        </div>
                    </div>
                </div>
                <div class="post-footer">
                    <button class="footer-btn" onclick="copyProductDetails()">
                        <i class="fas fa-copy"></i> Copy Details
                    </button>
                    <button class="footer-btn" onclick="exportProductDetailsAsJSON()">
                        <i class="fas fa-download"></i> Export JSON
                    </button>
                </div>
            </div>`;
            
            // Store product details data for copy functions
            window.productDetailsData = details;
            
            contentDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');
            
            // Add success animation
            resultDiv.classList.add('success-animation');
            setTimeout(() => resultDiv.classList.remove('success-animation'), 600);
        }

        function showRedditResult(result, isLoading = false, data = null, isError = false) {
            const resultDiv = document.getElementById('redditResult');
            const contentDiv = document.getElementById('redditResultContent');
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading"></div> ${result}`;
            } else {
                if (isError) {
                    contentDiv.innerHTML = `<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> ${result}</span>`;
                } else if (data) {
                    contentDiv.innerHTML = formatJSON(result, data);
                } else {
                    contentDiv.textContent = result;
                }
            }
            
            resultDiv.classList.remove('hidden');
        }

        function showViralPostsResult(result, isLoading = false, data = null, isError = false) {
            const resultDiv = document.getElementById('viralPostsResult');
            const contentDiv = document.getElementById('viralPostsResultContent');
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading"></div> ${result}`;
            } else {
                if (isError) {
                    contentDiv.innerHTML = `<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> ${result}</span>`;
                } else if (data) {
                    contentDiv.innerHTML = formatJSON(result, data);
                } else {
                    contentDiv.textContent = result;
                }
            }
            
            resultDiv.classList.remove('hidden');
        }

        function showKarmaResult(result, isLoading = false, data = null, isError = false) {
            const resultDiv = document.getElementById('karmaResult');
            const contentDiv = document.getElementById('karmaResultContent');
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading"></div> ${result}`;
            } else {
                if (isError) {
                    contentDiv.innerHTML = `<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> ${result}</span>`;
                } else if (data) {
                    contentDiv.innerHTML = formatJSON(result, data);
                } else {
                    contentDiv.textContent = result;
                }
            }
            
            resultDiv.classList.remove('hidden');
        }

        function showKarmaAnalysis(analysis) {
            const resultDiv = document.getElementById('karmaResult');
            const contentDiv = document.getElementById('karmaResultContent');
            
            // Format the analysis text for better readability
            const formattedAnalysis = formatKarmaAnalysis(analysis);
            
            let html = `<div class="success-message">
                <i class="fas fa-chart-line"></i>
                <strong>Success!</strong> Karma analysis completed from trending posts.
            </div>
            <div class="post-card">
                <div class="post-header">
                    <div class="post-meta">
                        <div class="subreddit-tag" style="background: #667eea;">
                            <i class="fas fa-chart-line"></i> Karma Analysis
                        </div>
                        <div class="post-number">AI Generated</div>
                    </div>
                </div>
                <div class="post-content">
                    <div style="white-space: pre-wrap; font-family: 'Segoe UI', sans-serif; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; line-height: 1.6; font-size: 14px;">
                        ${formattedAnalysis}
                    </div>
                </div>
                <div class="post-footer">
                    <button class="footer-btn" onclick="copyKarmaAnalysis()">
                        <i class="fas fa-copy"></i> Copy Analysis
                    </button>
                    <button class="footer-btn" onclick="exportKarmaAnalysisAsJSON()">
                        <i class="fas fa-download"></i> Export JSON
                    </button>
                    <button class="footer-btn" onclick="refreshKarmaAnalysis()">
                        <i class="fas fa-refresh"></i> Refresh Analysis
                    </button>
                </div>
            </div>`;
            
            // Store karma analysis data for copy functions
            window.karmaAnalysisData = analysis;
            
            contentDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');
            
            // Add success animation
            resultDiv.classList.add('success-animation');
            setTimeout(() => resultDiv.classList.remove('success-animation'), 600);
        }

        // Helper function to format karma analysis text
        function formatKarmaAnalysis(text) {
            // Convert markdown-style headers to HTML
            text = text.replace(/^# (.*$)/gm, '<h2 style="color: #667eea; margin: 20px 0 10px 0; font-size: 18px;">$1</h2>');
            text = text.replace(/^## (.*$)/gm, '<h3 style="color: #495057; margin: 15px 0 8px 0; font-size: 16px;">$1</h3>');
            text = text.replace(/^### (.*$)/gm, '<h4 style="color: #6c757d; margin: 12px 0 6px 0; font-size: 14px;">$1</h4>');
            
            // Convert bullet points
            text = text.replace(/^- (.*$)/gm, '<li style="margin: 5px 0; padding-left: 10px;">$1</li>');
            text = text.replace(/^(\d+)\. (.*$)/gm, '<li style="margin: 5px 0; padding-left: 10px;">$1. $2</li>');
            
            // Wrap lists in ul/ol tags
            text = text.replace(/(<li.*<\/li>)/gs, '<ul style="margin: 10px 0; padding-left: 20px;">$1</ul>');
            
            // Convert bold text
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #495057;">$1</strong>');
            
            // Convert italic text
            text = text.replace(/\*(.*?)\*/g, '<em style="color: #6c757d;">$1</em>');
            
            // Convert code blocks
            text = text.replace(/```(.*?)```/gs, '<code style="background: #e9ecef; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
            
            // Convert inline code
            text = text.replace(/`(.*?)`/g, '<code style="background: #e9ecef; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>');
            
            // Convert line breaks to paragraphs
            text = text.replace(/\n\n/g, '</p><p style="margin: 10px 0;">');
            text = '<p style="margin: 10px 0;">' + text + '</p>';
            
            return text;
        }

        // Function to refresh karma analysis
        function refreshKarmaAnalysis() {
            const subredditName = document.getElementById('subreddit_name').value;
            if (subredditName) {
                getKarmaAnalysis();
            } else {
                showToast('Please enter a subreddit name first', 'error');
            }
        }

        function showSmartKarmaAnalysis(analysis) {
            const resultDiv = document.getElementById('smartKarmaResult');
            const contentDiv = document.getElementById('smartKarmaResultContent');
            
            // Format the analysis text for better readability
            const formattedAnalysis = formatKarmaAnalysis(analysis);
            
            let html = `<div class="success-message">
                <i class="fas fa-magic"></i>
                <strong>Success!</strong> Personalized karma strategy generated based on your profile.
            </div>
            <div class="post-card">
                <div class="post-header">
                    <div class="post-meta">
                        <div class="subreddit-tag" style="background: #ff6b6b;">
                            <i class="fas fa-magic"></i> Smart Karma Plan
                        </div>
                        <div class="post-number">Personalized</div>
                    </div>
                </div>
                <div class="post-content">
                    <div style="white-space: pre-wrap; font-family: 'Segoe UI', sans-serif; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; line-height: 1.6; font-size: 14px;">
                        ${formattedAnalysis}
                    </div>
                </div>
                <div class="post-footer">
                    <button class="footer-btn" onclick="copySmartKarmaAnalysis()">
                        <i class="fas fa-copy"></i> Copy Plan
                    </button>
                    <button class="footer-btn" onclick="exportSmartKarmaAsJSON()">
                        <i class="fas fa-download"></i> Export JSON
                    </button>
                    <button class="footer-btn" onclick="refreshSmartKarmaAnalysis()">
                        <i class="fas fa-refresh"></i> Refresh Plan
                    </button>
                </div>
            </div>`;
            
            // Store smart karma analysis data for copy functions
            window.smartKarmaAnalysisData = analysis;
            
            contentDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');
            
            // Add success animation
            resultDiv.classList.add('success-animation');
            setTimeout(() => resultDiv.classList.remove('success-animation'), 600);
        }

        // Function to refresh smart karma analysis
        function refreshSmartKarmaAnalysis() {
            getSmartKarmaAnalysis();
        }

        function showKarmaPostsResult(message, isLoading = false, data = null, isError = false) {
            const resultDiv = document.getElementById('karmaPostsResult');
            const contentDiv = document.getElementById('karmaPostsResultContent');
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading"></div> ${message}`;
            } else {
                if (isError) {
                    contentDiv.innerHTML = `<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> ${message}</span>`;
                } else if (data) {
                    contentDiv.innerHTML = formatJSON(message, data);
                } else {
                    contentDiv.textContent = message;
                }
            }
            
            resultDiv.classList.remove('hidden');
        }

        function showKarmaPosts(posts) {
            const resultDiv = document.getElementById('karmaPostsResult');
            const contentDiv = document.getElementById('karmaPostsResultContent');
            
            if (posts.length === 0) {
                contentDiv.innerHTML = `
                    <div class="success-message">
                        <i class="fas fa-info-circle"></i>
                        <strong>No karma posts found.</strong> Generate your first karma post to get started!
                    </div>
                `;
            } else {
                let html = `<div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <strong>Success!</strong> Found ${posts.length} karma post(s).
                </div>
                <div class="post-grid">`;
                
                posts.forEach((post, index) => {
                    html += `
                        <div class="post-card">
                            <div class="post-header">
                                <div class="post-meta">
                                    <div class="subreddit-tag" style="background: #ff4500;">
                                        <i class="fab fa-reddit"></i> ${post.subreddit || 'Unknown'}
                                    </div>
                                    <div class="post-number">Karma Post ${index + 1}</div>
                                </div>
                            </div>
                            <div class="post-title">${post.title || 'No title'}</div>`;
                    
                    // Add image if available
                    if (post.image_url) {
                        html += `
                        <div style="margin: 15px 0; text-align: center;">
                            <img src="${post.image_url}" alt="Generated image" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                                <i class="fas fa-image"></i> WebP Image (Signed URL - expires in 1 hour)
                            </div>
                        </div>`;
                    }
                    
                    // Add description if available
                    if (post.description) {
                        html += `<div class="post-content">${post.description}</div>`;
                    }
                    
                    html += `
                            <div class="post-footer">
                                <button class="footer-btn" onclick="copyKarmaPostContent(${index})">
                                    <i class="fas fa-copy"></i> Copy Content
                                </button>
                                <button class="footer-btn" onclick="copyKarmaPostTitle(${index})">
                                    <i class="fas fa-heading"></i> Copy Title
                                </button>
                                <button class="footer-btn" onclick="copyKarmaPostAll(${index})">
                                    <i class="fas fa-clipboard"></i> Copy All
                                </button>
                                ${post.image_url ? `<button class="footer-btn" onclick="openKarmaPostImage(${index})">
                                    <i class="fas fa-external-link-alt"></i> Open Image
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Store karma posts data for copy functions
                window.karmaPostsData = posts;
                
                contentDiv.innerHTML = html;
            }
            
            resultDiv.classList.remove('hidden');
            
            // Add success animation
            resultDiv.classList.add('success-animation');
            setTimeout(() => resultDiv.classList.remove('success-animation'), 600);
        }

        function showKarmaPostResult(message, isLoading = false, data = null, isError = false) {
            const resultDiv = document.getElementById('karmaPostResult');
            const contentDiv = document.getElementById('karmaPostResultContent');
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading"></div> ${message}`;
            } else {
                if (isError) {
                    contentDiv.innerHTML = `<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> ${message}</span>`;
                } else if (data) {
                    contentDiv.innerHTML = formatJSON(message, data);
                } else {
                    contentDiv.textContent = message;
                }
            }
            
            resultDiv.classList.remove('hidden');
        }

        function showKarmaPost(postData) {
            const resultDiv = document.getElementById('karmaPostResult');
            const contentDiv = document.getElementById('karmaPostResultContent');
            
            let html = `<div class="success-message">
                <i class="fas fa-check-circle"></i>
                <strong>Success!</strong> Generated karma post with image and saved to database.
            </div>
            <div class="post-card">
                <div class="post-header">
                    <div class="post-meta">
                        <div class="subreddit-tag" style="background: #ff4500;">
                            <i class="fab fa-reddit"></i> ${postData.subreddit || 'Unknown'}
                        </div>
                        <div class="post-number">Karma Post</div>
                    </div>
                </div>
                <div class="post-title">${postData.title || 'No title'}</div>`;
            
            // Add image if available
            if (postData.image_url) {
                html += `
                <div style="margin: 15px 0; text-align: center;">
                    <img src="${postData.image_url}" alt="Generated image" style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                        <i class="fas fa-image"></i> WebP Image (Signed URL - expires in 1 hour)
                    </div>
                </div>`;
            }
            
            // Add description if available
            if (postData.description) {
                html += `<div class="post-content">${postData.description}</div>`;
            }
            
            // Add post metadata
            html += `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${postData.subreddit || 'Unknown'}</div>
                        <div class="stat-label">Subreddit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${postData.post_id ? 'Saved' : 'Not saved'}</div>
                        <div class="stat-label">Database Status</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${postData.image_url ? 'Signed URL' : 'Not available'}</div>
                        <div class="stat-label">Image Status</div>
                    </div>
                </div>
                <div class="post-footer">
                    <button class="footer-btn" onclick="copyKarmaPostContent()">
                        <i class="fas fa-copy"></i> Copy Content
                    </button>
                    <button class="footer-btn" onclick="copyKarmaPostTitle()">
                        <i class="fas fa-heading"></i> Copy Title
                    </button>
                    <button class="footer-btn" onclick="copyKarmaPostAll()">
                        <i class="fas fa-clipboard"></i> Copy All
                    </button>
                    <button class="footer-btn" onclick="openImageInNewTab()">
                        <i class="fas fa-external-link-alt"></i> Open Image
                    </button>
                </div>
            </div>`;
            
            // Store karma post data for copy functions
            window.karmaPostData = postData;
            
            contentDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');
            
            // Add success animation
            resultDiv.classList.add('success-animation');
            setTimeout(() => resultDiv.classList.remove('success-animation'), 600);
        }

        function showSmartKarmaResult(message, isLoading = false, data = null, isError = false) {
            const resultDiv = document.getElementById('smartKarmaResult');
            const contentDiv = document.getElementById('smartKarmaResultContent');
            
            if (isLoading) {
                contentDiv.innerHTML = `<div class="loading-message">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>${message}</span>
                </div>`;
                resultDiv.classList.remove('hidden');
                return;
            }
            
            if (isError) {
                contentDiv.innerHTML = `<div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${message}</span>
                </div>`;
                resultDiv.classList.remove('hidden');
                return;
            }
            
            if (data) {
                showSmartKarmaAnalysis(data);
            } else {
                contentDiv.innerHTML = `<div class="info-message">
                    <i class="fas fa-info-circle"></i>
                    <span>${message}</span>
                </div>`;
                resultDiv.classList.remove('hidden');
            }
        }

        function showViralPosts(posts) {
            const resultDiv = document.getElementById('viralPostsResult');
            const contentDiv = document.getElementById('viralPostsResultContent');
            
            let html = `<div class="success-message">
                <i class="fas fa-fire"></i>
                <strong>Success!</strong> Loaded ${posts.length} viral posts for inspiration.
            </div>
            <div class="post-grid">`;
            
            posts.forEach((post, index) => {
                const title = post.title || 'No title';
                const description = post.description || 'No description';
                const subreddit = post.subreddit || 'Unknown';
                const upvotes = post.upvotes || 0;
                const comments = post.comments || 0;
                
                html += `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="post-meta">
                                <div class="subreddit-tag">
                                    <i class="fab fa-reddit"></i> ${subreddit}
                                </div>
                                <div class="post-number">Viral Post ${index + 1}</div>
                            </div>
                        </div>
                        <div class="post-title">${title}</div>
                        <div class="post-content">${description}</div>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-number">${upvotes}</div>
                                <div class="stat-label">Upvotes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${comments}</div>
                                <div class="stat-label">Comments</div>
                            </div>
                        </div>
                        <div class="post-footer">
                            <button class="footer-btn" onclick="copyViralPostContent(${index})">
                                <i class="fas fa-copy"></i> Copy Content
                            </button>
                            <button class="footer-btn" onclick="copyViralPostTitle(${index})">
                                <i class="fas fa-heading"></i> Copy Title
                            </button>
                            <button class="footer-btn" onclick="copyViralPostAll(${index})">
                                <i class="fas fa-clipboard"></i> Copy All
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Store viral posts data for copy functions
            window.viralPostsData = posts;
            
            contentDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');
            
            // Add success animation
            resultDiv.classList.add('success-animation');
            setTimeout(() => resultDiv.classList.remove('success-animation'), 600);
        }

        function showRedditPosts(posts, data) {
            const resultDiv = document.getElementById('redditResult');
            const contentDiv = document.getElementById('redditResultContent');
            
            let html = `<div class="success-message">
                <i class="fas fa-check-circle"></i>
                <strong>Success!</strong> Generated ${posts.length} Reddit posts for your product.
            </div>
            <div class="post-grid">`;
            
            posts.forEach((post, index) => {
                const subreddit = post['r/subreddit'] || post.subreddit || 'Unknown';
                const title = post.Title || post.title || 'No title';
                const body = post.Post || post.post || 'No content';
                
                html += `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="post-meta">
                                <div class="subreddit-tag">
                                    <i class="fab fa-reddit"></i> ${subreddit}
                                </div>
                                <div class="post-number">Post ${index + 1}</div>
                            </div>
                        </div>
                        <div class="post-title">${title}</div>
                        <div class="post-content">${body}</div>
                        <div class="post-footer">
                            <button class="footer-btn" onclick="copyPostContent(${index})">
                                <i class="fas fa-copy"></i> Copy Content
                            </button>
                            <button class="footer-btn" onclick="copyPostTitle(${index})">
                                <i class="fas fa-heading"></i> Copy Title
                            </button>
                            <button class="footer-btn" onclick="copyPostAll(${index})">
                                <i class="fas fa-clipboard"></i> Copy All
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Store posts data for copy functions
            window.redditPostsData = posts;
            
            contentDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');
            
            // Add success animation
            resultDiv.classList.add('success-animation');
            setTimeout(() => resultDiv.classList.remove('success-animation'), 600);
        }

        function formatJSON(text, data) {
            // Simple JSON syntax highlighting
            let formatted = text.replace(/(".*?":)/g, '<span class="json-key">$1</span>');
            formatted = formatted.replace(/(".*?")/g, '<span class="json-string">$1</span>');
            formatted = formatted.replace(/\b(\d+\.?\d*)\b/g, '<span class="json-number">$1</span>');
            formatted = formatted.replace(/\b(true|false)\b/g, '<span class="json-boolean">$1</span>');
            formatted = formatted.replace(/\bnull\b/g, '<span class="json-null">null</span>');
            return formatted;
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const content = element.querySelector('.result-content').textContent;
            
            navigator.clipboard.writeText(content).then(() => {
                const btn = element.querySelector('.copy-btn');
                const icon = btn.querySelector('i');
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('copied');
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function copyPostContent(index) {
            if (!window.redditPostsData || !window.redditPostsData[index]) {
                showToast('Post data not available', 'error');
                return;
            }
            
            const post = window.redditPostsData[index];
            const content = post.Post || post.post || 'No content';
            
            navigator.clipboard.writeText(content).then(() => {
                showToast('Post content copied to clipboard!', 'success');
                updateButtonState(index, 'content');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function copyPostTitle(index) {
            if (!window.redditPostsData || !window.redditPostsData[index]) {
                showToast('Post data not available', 'error');
                return;
            }
            
            const post = window.redditPostsData[index];
            const title = post.Title || post.title || 'No title';
            
            navigator.clipboard.writeText(title).then(() => {
                showToast('Post title copied to clipboard!', 'success');
                updateButtonState(index, 'title');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function copyPostAll(index) {
            if (!window.redditPostsData || !window.redditPostsData[index]) {
                showToast('Post data not available', 'error');
                return;
            }
            
            const post = window.redditPostsData[index];
            const subreddit = post['r/subreddit'] || post.subreddit || 'Unknown';
            const title = post.Title || post.title || 'No title';
            const content = post.Post || post.post || 'No content';
            
            const fullPost = `Subreddit: ${subreddit}\nTitle: ${title}\n\nContent:\n${content}`;
            
            navigator.clipboard.writeText(fullPost).then(() => {
                showToast('Complete post copied to clipboard!', 'success');
                updateButtonState(index, 'all');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        // Viral Posts Copy Functions
        function copyViralPostContent(index) {
            if (!window.viralPostsData || !window.viralPostsData[index]) {
                showToast('Viral post data not available', 'error');
                return;
            }
            
            const post = window.viralPostsData[index];
            const content = post.description || 'No content';
            
            navigator.clipboard.writeText(content).then(() => {
                showToast('Viral post content copied to clipboard!', 'success');
                updateViralButtonState(index, 'content');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function copyViralPostTitle(index) {
            if (!window.viralPostsData || !window.viralPostsData[index]) {
                showToast('Viral post data not available', 'error');
                return;
            }
            
            const post = window.viralPostsData[index];
            const title = post.title || 'No title';
            
            navigator.clipboard.writeText(title).then(() => {
                showToast('Viral post title copied to clipboard!', 'success');
                updateViralButtonState(index, 'title');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function copyViralPostAll(index) {
            if (!window.viralPostsData || !window.viralPostsData[index]) {
                showToast('Viral post data not available', 'error');
                return;
            }
            
            const post = window.viralPostsData[index];
            const subreddit = post.subreddit || 'Unknown';
            const title = post.title || 'No title';
            const content = post.description || 'No content';
            const upvotes = post.upvotes || 0;
            const comments = post.comments || 0;
            
            const fullPost = `Subreddit: ${subreddit}\nTitle: ${title}\nUpvotes: ${upvotes}\nComments: ${comments}\n\nContent:\n${content}`;
            
            navigator.clipboard.writeText(fullPost).then(() => {
                showToast('Complete viral post copied to clipboard!', 'success');
                updateViralButtonState(index, 'all');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        // Karma Analysis Copy Functions
        function copyKarmaAnalysis() {
            if (window.karmaAnalysisData) {
                navigator.clipboard.writeText(window.karmaAnalysisData).then(() => {
                    showToast('Karma analysis copied to clipboard!', 'success');
                    updateKarmaButtonState('copy');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('Failed to copy to clipboard', 'error');
                });
            } else {
                showToast('No karma analysis to copy', 'error');
            }
        }

        function exportKarmaAnalysisAsJSON() {
            if (window.karmaAnalysisData) {
                const dataStr = JSON.stringify({ analysis: window.karmaAnalysisData }, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'karma_analysis.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Karma analysis exported as JSON!', 'success');
                updateKarmaButtonState('export');
            } else {
                showToast('No karma analysis to export', 'error');
            }
        }

        function updateKarmaButtonState(type) {
            const postCard = document.querySelector('#karmaResult .post-card');
            if (!postCard) return;
            
            const buttons = postCard.querySelectorAll('.footer-btn');
            buttons.forEach(btn => btn.classList.remove('success'));
            
            if (type === 'copy') {
                buttons[0].classList.add('success');
            } else if (type === 'export') {
                buttons[1].classList.add('success');
            }
            
            setTimeout(() => {
                buttons.forEach(btn => btn.classList.remove('success'));
            }, 2000);
        }

        // Smart Karma Analysis Copy Functions
        function copySmartKarmaAnalysis() {
            if (window.smartKarmaAnalysisData) {
                navigator.clipboard.writeText(window.smartKarmaAnalysisData).then(() => {
                    showToast('Smart karma plan copied to clipboard!', 'success');
                    updateSmartKarmaButtonState('copy');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('Failed to copy to clipboard', 'error');
                });
            } else {
                showToast('No smart karma plan to copy', 'error');
            }
        }

        function exportSmartKarmaAsJSON() {
            if (window.smartKarmaAnalysisData) {
                const dataStr = JSON.stringify({ smart_karma_plan: window.smartKarmaAnalysisData }, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'smart_karma_plan.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Smart karma plan exported as JSON!', 'success');
                updateSmartKarmaButtonState('export');
            } else {
                showToast('No smart karma plan to export', 'error');
            }
        }

        function updateSmartKarmaButtonState(type) {
            const postCard = document.querySelector('#smartKarmaResult .post-card');
            if (!postCard) return;
            
            const buttons = postCard.querySelectorAll('.footer-btn');
            buttons.forEach(btn => btn.classList.remove('success'));
            
            if (type === 'copy') {
                buttons[0].classList.add('success');
            } else if (type === 'export') {
                buttons[1].classList.add('success');
            }
            
            setTimeout(() => {
                buttons.forEach(btn => btn.classList.remove('success'));
            }, 2000);
        }

        // Karma Post Copy Functions
        function copyKarmaPostContent() {
            if (!window.karmaPostData) {
                showToast('Karma post data not available', 'error');
                return;
            }
            
            const content = window.karmaPostData.description || 'No content';
            
            navigator.clipboard.writeText(content).then(() => {
                showToast('Karma post content copied to clipboard!', 'success');
                updateKarmaPostButtonState('content');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function copyKarmaPostTitle() {
            if (!window.karmaPostData) {
                showToast('Karma post data not available', 'error');
                return;
            }
            
            const title = window.karmaPostData.title || 'No title';
            
            navigator.clipboard.writeText(title).then(() => {
                showToast('Karma post title copied to clipboard!', 'success');
                updateKarmaPostButtonState('title');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function copyKarmaPostAll() {
            if (!window.karmaPostData) {
                showToast('Karma post data not available', 'error');
                return;
            }
            
            const post = window.karmaPostData;
            const subreddit = post.subreddit || 'Unknown';
            const title = post.title || 'No title';
            const content = post.description || 'No content';
            const imageUrl = post.image_url || 'No image';
            
            const fullPost = `Subreddit: ${subreddit}\nTitle: ${title}\n\nContent:\n${content}\n\nImage URL: ${imageUrl}`;
            
            navigator.clipboard.writeText(fullPost).then(() => {
                showToast('Complete karma post copied to clipboard!', 'success');
                updateKarmaPostButtonState('all');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function openImageInNewTab() {
            if (!window.karmaPostData || !window.karmaPostData.image_url) {
                showToast('No image available to open', 'error');
                return;
            }
            
            window.open(window.karmaPostData.image_url, '_blank');
            showToast('Image opened in new tab!', 'success');
            updateKarmaPostButtonState('image');
        }

        // Karma Posts List Copy Functions
        function copyKarmaPostContent(index) {
            if (!window.karmaPostsData || !window.karmaPostsData[index]) {
                showToast('Karma post data not available', 'error');
                return;
            }
            
            const post = window.karmaPostsData[index];
            const content = post.description || 'No content';
            
            navigator.clipboard.writeText(content).then(() => {
                showToast('Karma post content copied to clipboard!', 'success');
                updateKarmaPostsButtonState(index, 'content');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function copyKarmaPostTitle(index) {
            if (!window.karmaPostsData || !window.karmaPostsData[index]) {
                showToast('Karma post data not available', 'error');
                return;
            }
            
            const post = window.karmaPostsData[index];
            const title = post.title || 'No title';
            
            navigator.clipboard.writeText(title).then(() => {
                showToast('Karma post title copied to clipboard!', 'success');
                updateKarmaPostsButtonState(index, 'title');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function copyKarmaPostAll(index) {
            if (!window.karmaPostsData || !window.karmaPostsData[index]) {
                showToast('Karma post data not available', 'error');
                return;
            }
            
            const post = window.karmaPostsData[index];
            const subreddit = post.subreddit || 'Unknown';
            const title = post.title || 'No title';
            const content = post.description || 'No content';
            const imageUrl = post.image_url || 'No image';
            
            const fullPost = `Subreddit: ${subreddit}\nTitle: ${title}\n\nContent:\n${content}\n\nImage URL: ${imageUrl}`;
            
            navigator.clipboard.writeText(fullPost).then(() => {
                showToast('Complete karma post copied to clipboard!', 'success');
                updateKarmaPostsButtonState(index, 'all');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function openKarmaPostImage(index) {
            if (!window.karmaPostsData || !window.karmaPostsData[index] || !window.karmaPostsData[index].image_url) {
                showToast('No image available to open', 'error');
                return;
            }
            
            window.open(window.karmaPostsData[index].image_url, '_blank');
            showToast('Image opened in new tab!', 'success');
            updateKarmaPostsButtonState(index, 'image');
        }

        function updateKarmaPostsButtonState(index, type) {
            const postCards = document.querySelectorAll('#karmaPostsResult .post-card');
            if (!postCards[index]) return;
            
            const buttons = postCards[index].querySelectorAll('.footer-btn');
            buttons.forEach(btn => btn.classList.remove('success'));
            
            if (type === 'content') {
                buttons[0].classList.add('success');
            } else if (type === 'title') {
                buttons[1].classList.add('success');
            } else if (type === 'all') {
                buttons[2].classList.add('success');
            } else if (type === 'image' && buttons[3]) {
                buttons[3].classList.add('success');
            }
            
            setTimeout(() => {
                buttons.forEach(btn => btn.classList.remove('success'));
            }, 2000);
        }

        function updateKarmaPostButtonState(type) {
            const postCard = document.querySelector('#karmaPostResult .post-card');
            if (!postCard) return;
            
            const buttons = postCard.querySelectorAll('.footer-btn');
            buttons.forEach(btn => btn.classList.remove('success'));
            
            if (type === 'content') {
                buttons[0].classList.add('success');
            } else if (type === 'title') {
                buttons[1].classList.add('success');
            } else if (type === 'all') {
                buttons[2].classList.add('success');
            } else if (type === 'image') {
                buttons[3].classList.add('success');
            }
            
            setTimeout(() => {
                buttons.forEach(btn => btn.classList.remove('success'));
            }, 2000);
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            // Set background color based on type
            if (type === 'success') {
                toast.style.background = '#28a745';
            } else if (type === 'error') {
                toast.style.background = '#dc3545';
            } else {
                toast.style.background = '#17a2b8';
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function updateViralButtonState(index, type) {
            const postCard = document.querySelectorAll('.post-card')[index];
            if (!postCard) return;
            
            const buttons = postCard.querySelectorAll('.footer-btn');
            buttons.forEach(btn => btn.classList.remove('success'));
            
            if (type === 'content') {
                buttons[0].classList.add('success');
            } else if (type === 'title') {
                buttons[1].classList.add('success');
            } else if (type === 'all') {
                buttons[2].classList.add('success');
            }
            
            setTimeout(() => {
                buttons.forEach(btn => btn.classList.remove('success'));
            }, 2000);
        }

        function copyAllPosts() {
            if (!window.redditPostsData || window.redditPostsData.length === 0) {
                showToast('No posts available to copy', 'error');
                return;
            }
            
            let allPosts = '';
            window.redditPostsData.forEach((post, index) => {
                const subreddit = post['r/subreddit'] || post.subreddit || 'Unknown';
                const title = post.Title || post.title || 'No title';
                const content = post.Post || post.post || 'No content';
                
                allPosts += `=== Post ${index + 1} (${subreddit}) ===\nTitle: ${title}\n\nContent:\n${content}\n\n`;
            });
            
            navigator.clipboard.writeText(allPosts).then(() => {
                showToast('All posts copied to clipboard!', 'success');
                updateCopyAllButton();
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function exportAsJSON() {
            if (!window.redditPostsData || window.redditPostsData.length === 0) {
                showToast('No posts available to export', 'error');
                return;
            }
            
            const jsonData = JSON.stringify(window.redditPostsData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'reddit_posts.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Posts exported as JSON!', 'success');
        }

        function updateButtonState(index, type) {
            const postCard = document.querySelectorAll('.post-card')[index];
            if (!postCard) return;
            
            const buttons = postCard.querySelectorAll('.footer-btn');
            buttons.forEach(btn => btn.classList.remove('success'));
            
            if (type === 'content') {
                buttons[0].classList.add('success');
            } else if (type === 'title') {
                buttons[1].classList.add('success');
            } else if (type === 'all') {
                buttons[2].classList.add('success');
            }
            
            setTimeout(() => {
                buttons.forEach(btn => btn.classList.remove('success'));
            }, 2000);
        }

        function updateCopyAllButton() {
            const copyAllBtn = document.querySelector('.action-btn');
            if (copyAllBtn) {
                copyAllBtn.classList.add('success');
                copyAllBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                
                setTimeout(() => {
                    copyAllBtn.classList.remove('success');
                    copyAllBtn.innerHTML = '<i class="fas fa-copy"></i> Copy All';
                }, 2000);
            }
        }

        function showToast(message, type) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}"></i> ${message}`;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Copy product details to clipboard
        function copyProductDetails() {
            if (window.productDetailsData) {
                const detailsText = `Target Audience: ${window.productDetailsData.target_audience || 'Not specified'}
Description: ${window.productDetailsData.description || 'Not specified'}
Problem Solved: ${window.productDetailsData.problem_solved || 'Not specified'}`;
                
                navigator.clipboard.writeText(detailsText).then(() => {
                    showToast('Product details copied to clipboard!', 'success');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('Failed to copy to clipboard', 'error');
                });
            } else {
                showToast('No product details to copy', 'error');
            }
        }

        // Export product details as JSON
        function exportProductDetailsAsJSON() {
            if (window.productDetailsData) {
                const dataStr = JSON.stringify(window.productDetailsData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'product_details.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Product details exported as JSON!', 'success');
            } else {
                showToast('No product details to export', 'error');
            }
        }

        // Product Selection Functions
        let userProducts = [];
        let selectedProductId = null;

        async function loadUserProducts() {
            if (!accessToken) {
                showToast('You must be signed in to load products', 'error');
                return;
            }

            try {
                showToast('Loading your products...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/products`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.products) {
                    userProducts = data.products;
                    populateProductDropdown();
                    showToast(`Loaded ${data.products.length} product(s)`, 'success');
                } else {
                    showToast(`Error: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        function populateProductDropdown() {
            const select = document.getElementById('product_select');
            select.innerHTML = '<option value="">-- Select a product --</option>';
            
            userProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name;
                select.appendChild(option);
            });
        }

        function onProductSelect() {
            const select = document.getElementById('product_select');
            const selectedId = select.value;
            const generateBtn = document.getElementById('generateRedditBtn');
            const productInfo = document.getElementById('selectedProductInfo');
            const productInfoContent = document.getElementById('productInfoContent');
            
            if (selectedId) {
                selectedProductId = selectedId;
                const product = userProducts.find(p => p.id === selectedId);
                
                if (product) {
                    productInfoContent.innerHTML = `
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-label">Name</div>
                                <div class="stat-number" style="font-size: 16px; color: #495057;">${product.name}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Description</div>
                                <div class="stat-number" style="font-size: 16px; color: #495057;">${product.description || 'Not specified'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Target Audience</div>
                                <div class="stat-number" style="font-size: 16px; color: #495057;">${product.target_audience || 'Not specified'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Problem Solved</div>
                                <div class="stat-number" style="font-size: 16px; color: #495057;">${product.problem_solved || 'Not specified'}</div>
                            </div>
                            ${product.url ? `
                            <div class="stat-card">
                                <div class="stat-label">URL</div>
                                <div class="stat-number" style="font-size: 16px; color: #495057;">
                                    <a href="${product.url}" target="_blank">${product.url}</a>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    productInfo.classList.remove('hidden');
                    generateBtn.disabled = false;
                }
            } else {
                selectedProductId = null;
                productInfo.classList.add('hidden');
                generateBtn.disabled = true;
            }
        }

        // Updated Generate Reddit Post function
        async function generateRedditPost() {
            if (!selectedProductId) {
                showRedditResult('Error: Please select a product first.', null, true);
                return;
            }

            try {
                showRedditResult('Generating Reddit posts...', true);
                
                const response = await fetch(`${API_BASE_URL}/generate-reddit-post`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_id: selectedProductId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.response) {
                    // Try to parse the response as JSON
                    let posts;
                    try {
                        posts = JSON.parse(data.response);
                        
                        // Check if it's an array
                        if (Array.isArray(posts)) {
                            // Display formatted Reddit posts
                            showRedditPosts(posts, data);
                        } else {
                            // If it's not an array, try to extract from the response
                            showRedditResult(`Status: ${response.status} ${response.statusText}\n\nUnexpected format. Expected array but got:\n${JSON.stringify(posts, null, 2)}`, false, data);
                        }
                    } catch (e) {
                        // If parsing fails, show raw response
                        showRedditResult(`Status: ${response.status} ${response.statusText}\n\nRaw Response:\n${data.response}`, false, data);
                    }
                } else {
                    // Handle error responses
                    let errorMessage = 'Unknown error';
                    if (data.error) {
                        errorMessage = data.error;
                    } else if (data.response && data.response.includes('failed_generation')) {
                        // Try to extract the actual JSON from the error
                        try {
                            const match = data.response.match(/'failed_generation':\s*'([^']+)'/);
                            if (match) {
                                const extractedJson = match[1].replace(/\\"/g, '"').replace(/\\\\/g, '\\');
                                const posts = JSON.parse(extractedJson);
                                if (Array.isArray(posts)) {
                                    showRedditPosts(posts, data);
                                    return;
                                }
                            }
                        } catch (parseError) {
                            console.log('Failed to parse extracted JSON:', parseError);
                        }
                        errorMessage = 'JSON validation failed, but posts were generated. Check the raw response.';
                    }
                    showRedditResult(`Error: ${errorMessage}`, false, null, true);
                }
            } catch (error) {
                showRedditResult(`Error: ${error.message}`, false, null, true);
            }
        }

        // New Product Creation with AI Details
        function checkNewProductLink() {
            const productLink = document.getElementById('newProductUrl').value;
            const generateDetailsBtn = document.getElementById('generateNewProductDetailsBtn');
            
            if (productLink && productLink.trim() !== '') {
                generateDetailsBtn.style.display = 'inline-flex';
            } else {
                generateDetailsBtn.style.display = 'none';
            }
        }

        async function generateNewProductDetails() {
            const productWebsiteLink = document.getElementById('newProductUrl').value;

            if (!productWebsiteLink) {
                showToast('Please enter a product website link first.', 'error');
                return;
            }

            try {
                showToast('Generating product details with AI...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/generate-product-details`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        product_website_link: productWebsiteLink
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data) {
                    // Auto-fill the form fields with generated details
                    if (data.target_audience) {
                        document.getElementById('newProductTargetAudience').value = data.target_audience;
                    }
                    if (data.description) {
                        document.getElementById('newProductDescription').value = data.description;
                    }
                    if (data.problem_solved) {
                        document.getElementById('newProductProblemSolved').value = data.problem_solved;
                    }
                    
                    showToast('Product details generated and form filled automatically!', 'success');
                } else {
                    showToast(`Error: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        // Remove old functions that are no longer needed
        function checkProductLink() {
            // This function is no longer needed
        }

        function generateProductDetails() {
            // This function is no longer needed
        }

        // Initialize when page loads
        window.onload = function() {
            initSupabase();
            setupModalHandlers();
            // Auto-load products when user is authenticated
            if (accessToken) {
                loadUserProducts();
            }
        };
    </script>
</body>
</html>
