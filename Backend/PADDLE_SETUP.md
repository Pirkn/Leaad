# Paddle Billing Integration Setup Guide

This guide will help you set up Paddle billing integration for your Marketing Agent SaaS with a Pro plan ($19/month with 3-day free trial).

## Prerequisites

1. **Paddle Account**: Create a Paddle account at [paddle.com](https://paddle.com)
2. **API Keys**: Generate API keys in Paddle Dashboard > Developer Tools > Authentication
3. **Webhook Secret**: Generate a webhook secret in Paddle Dashboard > Developer Tools > Webhooks

## Environment Variables

Add these to your `.env` file:

```bash
# Paddle Configuration
PADDLE_API_SECRET_KEY=your_paddle_api_secret_key_here
PADDLE_WEBHOOK_SECRET=your_webhook_secret_here
PADDLE_ENV=SANDBOX  # or LIVE for production
PADDLE_PRICE_ID_PRO_MONTHLY=your_price_id_here  # Will be generated by setup script
```

## Step 1: Set Up Paddle Products and Prices

Run the setup script to create your Pro plan product and recurring price:

```bash
cd Backend
python setup_paddle_products.py
```

This script will:
- Create a "Marketing Agent Pro Plan" product
- Create a recurring price of $19/month with 3-day free trial
- Save the IDs to `.paddle_ids.txt`
- Display the IDs to add to your `.env` file

## Step 2: Set Up Database Schema

Run the SQL commands in `supabase_schema.sql` in your Supabase SQL editor:

1. Go to your Supabase Dashboard
2. Navigate to SQL Editor
3. Copy and paste the contents of `supabase_schema.sql`
4. Execute the script

This creates:
- `paddle_transactions` table for tracking checkout sessions
- `subscriptions` table for subscription management
- `user_subscriptions` table for user subscription status (separate from auth.users)
- Sets up Row Level Security policies
- Creates a trigger to automatically create user_subscriptions records for new users

## Step 3: Configure Webhooks

In your Paddle Dashboard:

1. Go to Developer Tools > Webhooks
2. Add a new webhook endpoint: `https://yourdomain.com/billing/webhook`
3. Select these events:
   - `subscription.created`
   - `subscription.activated`
   - `subscription.canceled`
   - `subscription.paused`
   - `subscription.resumed`
   - `transaction.completed`
   - `transaction.payment_failed`
4. Copy the webhook secret to your `.env` file

## Step 4: Test the Integration

### Test Checkout Creation

```bash
curl -X POST http://localhost:5000/billing/create-checkout \
  -H "Authorization: Bearer YOUR_SUPABASE_JWT" \
  -H "Content-Type: application/json" \
  -d '{}'
```

### Test Subscription Status

```bash
curl -X GET http://localhost:5000/billing/subscription-status \
  -H "Authorization: Bearer YOUR_SUPABASE_JWT"
```

## API Endpoints

### POST /billing/create-checkout
Creates a Paddle checkout session for the Pro plan.

**Request Body (optional):**
```json
{
  "return_url": "https://yourdomain.com/dashboard",
  "success_url": "https://yourdomain.com/dashboard?subscription=active",
  "cancel_url": "https://yourdomain.com/pricing?canceled=true"
}
```

**Response:**
```json
{
  "checkout_url": "https://checkout.paddle.com/...",
  "transaction_id": "txn_...",
  "user_id": "user_uuid"
}
```

### GET /billing/subscription-status
Get the current subscription status for the authenticated user.

**Response:**
```json
{
  "subscription_status": "pro", // free, pro, canceled, paused
  "activated_at": "2024-01-01T00:00:00Z",
  "canceled_at": null
}
```

### POST /billing/webhook
Handles Paddle webhook events (internal use only).

## Webhook Events Handled

- **subscription.created**: Records new subscription
- **subscription.activated**: Activates user's Pro status
- **subscription.canceled**: Cancels user's Pro status
- **subscription.paused**: Pauses user's Pro status
- **subscription.resumed**: Resumes user's Pro status
- **transaction.completed**: Updates transaction status
- **transaction.payment_failed**: Records failed payment

## Database Tables

### paddle_transactions
Stores checkout session information:
- `id`: Paddle transaction ID
- `user_id`: User UUID
- `status`: pending, completed, failed
- `checkout_url`: Paddle checkout URL
- `price_id`: Paddle price ID
- `created_at`, `completed_at`, `failed_at`: Timestamps

### subscriptions
Stores subscription information:
- `id`: Internal subscription ID
- `user_id`: User UUID
- `paddle_subscription_id`: Paddle subscription ID
- `status`: created, active, canceled, paused
- `plan`: pro_monthly
- Various timestamps for lifecycle events

### user_subscriptions
Stores user subscription status (separate from auth.users):
- `id`: Internal record ID
- `user_id`: References auth.users(id)
- `subscription_status`: free, pro, canceled, paused
- `subscription_activated_at`: When Pro was activated
- `subscription_canceled_at`: When Pro was canceled
- `created_at`, `updated_at`: Timestamps

## Testing in Sandbox

1. Use test card numbers from Paddle's sandbox documentation
2. Test webhook events using Paddle's webhook simulator
3. Verify subscription status changes in your database
4. Test the complete flow: checkout → payment → activation

## Going Live

1. Switch `PADDLE_ENV` to `LIVE`
2. Update API keys to live environment
3. Recreate products and prices in live environment
4. Update webhook endpoint to production URL
5. Test with real payment methods

## Troubleshooting

### Common Issues

1. **"PADDLE_API_SECRET_KEY is not set"**
   - Check your `.env` file has the correct API key

2. **"Webhook secret not configured"**
   - Add `PADDLE_WEBHOOK_SECRET` to your `.env` file

3. **"Signature verification failed"**
   - Verify webhook secret matches Paddle dashboard
   - Check webhook URL is accessible

4. **Database errors**
   - Ensure SQL schema is properly executed
   - Check RLS policies are configured correctly

### Debug Mode

Enable debug logging by setting:
```bash
FLASK_DEBUG=1
```

This will show detailed error messages and webhook payloads.

## Security Notes

- Never expose API keys in client-side code
- Always verify webhook signatures
- Use HTTPS in production
- Implement proper error handling
- Monitor webhook failures
- Keep API keys secure and rotate regularly
